---
SideBar_Pocation: 4
Tiêu đề: Tự động hóa điều khiển thử nghiệm với Pyats Cisco
# slug:/nội bộ/ccna/không dây/xác định-radius-server-beable-snmp-syslog
Tags:
- Cisco
- Tự động hóa
- Pyats
---

Nhập điểm nổi bật từ '@site/src/các thành phần/điểm nổi bật';
Nhập các tab từ '@chủ đề/tab';
Nhập tabitem từ '@ chủ đề / tabitem';
Nhập CodeBlock từ '@Theme/CodeBlock';

## Pyats là gì?
! [] (./ img/what_is_pyats.jpg)

Ban đầu được phát triển để sử dụng Kỹ thuật Cisco nội bộ, Pyats là cốt lõi của giải pháp tự động hóa thử nghiệm Cisco.Pyats đã được cung cấp, miễn phí, cho công chúng vào năm 2017.-

Nó hiện đang được sử dụng:

- Là khung thử nghiệm thực tế cho các kỹ sư Cisco nội bộ trên các nền tảng và chức năng khác nhau, chạy hàng triệu CI/CD, sự tỉnh táo, hồi quy, quy mô, tính sẵn sàng cao và kiểm tra giải pháp hàng tháng
- Bởi hàng ngàn kỹ sư và nhà phát triển mạng trên toàn thế giới, bên ngoài Cisco
- Trong Cisco để cung cấp sự tỉnh táo, tính năng, giải pháp, hệ thống và kiểm tra quy mô và tự động hóa xác minh cho các sản phẩm từ bộ định tuyến và chuyển đổi đến các điểm truy cập, tường lửa và CPE cáp

Trong hướng dẫn này, trước tiên chúng tôi sẽ sử dụng Pyats từ CLI và sau đó tạo ra một công việc Pyats bằng cách sử dụng tập lệnh Python.

! [] (./ img/what_is_pyats_2.jpg)

## Cách tạo môi trường ảo Python 3
Pyats là tốt nhất chạy bên trong môi trường ảo Python 3.Môi trường ảo là các môi trường bị cô lập có thể được sử dụng để cài đặt các phụ thuộc, được gọi là các gói, trong sự cô lập với hệ điều hành chính và các môi trường ảo khác.

Đầu tiên, cài đặt VENV cho Python 3.10:

```bash
apt install -y python3.10-venv
```

Sau khi VENV đã được cài đặt, hãy tạo một môi trường ảo:

```bash
$ python3 -m venv pyats-env
```

Bây giờ, kích hoạt môi trường ảo:

```bash
$ source pyats-env/bin/activate
(pyats-env) $
```

## Cài đặt Pyats
Bên trong môi trường ảo Python 3 được kích hoạt, sử dụng Trình quản lý gói Python, PIP, để cài đặt Pyats:

```bash
(pyats-env) $ pip install pyats[full]
(pyats-env) $ pip install tabulate
```

## Cách tạo một bài kiểm tra Pyats

Pyats sử dụng khái niệm "thử nghiệm" để mô tả các thiết bị, bao gồm các yêu cầu kết nối của chúng.TestBeds cũng bao gồm một số thông tin bổ sung như hệ điều hành của nền tảng.Tạo một thử nghiệm Pyats dựa trên SSH cho hộp cát IOS XE luôn luôn bật của Cisco DevNet.Khởi chạy mã vs và tạo tệp YAML sau:

```yaml
---

devices:
    csr1000v-1:
        alias: 'DevNet_Sandbox_CSR1000v'
        type: 'router'
        os: 'iosxe'
        platform: isr
        credentials:
            default:
                username: developer
                password: C1sco12345
        connections:
            cli:
                protocol: ssh
                ip: sandbox-iosxe-latest-1.cisco.com
                port: 22
                arguments:
                    connection_timeout: 360
```

Lưu tệp dưới dạng `testbed_ssh.yaml`.

## Xác thực tệp thử nghiệm
Pyats có lệnh xác thực bạn có thể sử dụng để xác thực cấu trúc và cú pháp của tệp được kiểm tra.

Xác thực tệp đã kiểm tra của bạn:

```bash
(pyats-env) $ pyats validate testbed --testbed-file testbed_ssh.yaml
```

Xem xét và sửa bất kỳ tin nhắn xơ hình nào được tìm thấy bởi Pyats xác nhận trước khi chuyển sang bước tiếp theo.

## Cách sử dụng Pyats Tìm hiểu các mô hình từ CLI
Bây giờ chúng tôi đã thử nghiệm, chúng tôi có thể sử dụng Pyats tại CLI để tìm hiểu về trạng thái của thiết bị bằng các mô hình PYATS.

Các mô hình PYATS là không chính xác về nền tảng và có thể được sử dụng để thu thập đầu ra CLI và biến nó thành ký hiệu đối tượng JavaScript có cấu trúc (JSON).

Sử dụng lệnh `pyats learn interface` để tìm hiểu về các giao diện hộp cát iOS XE bằng cách tham chiếu tệp testbed_ssh.yaml:

```bash
(pyats-env) $ pyats learn interface --testbed-file testbed_ssh.yaml
```

Ba tệp sẽ được tạo bởi lệnh này:

- `Connection_CSR1000V-1.txt`

Một bản ghi của kết nối SSH:

- `interface_iosxe_csr1000V-1_console.txt`

Một bản ghi của đầu ra CLI tiêu chuẩn thô thường được hiển thị trên bảng điều khiển bằng SSH:

- `interface_iosxe_csr1000V-1_ops.txt`

Một phiên bản cấu trúc JSON của đầu ra CLI;Đặc biệt chú ý đến phần "thông tin" nơi tìm thấy đầu ra có cấu trúc JSON của trạng thái giao diện.

Sử dụng mã VS để kiểm tra từng trong ba tệp này.

Có 32 mô hình có sẵn mà bạn có thể học bằng Pyats.Hãy thử một số mô hình khác:

Truy cập [Mô hình Pyats] (https://developer.cisco.com/docs/genie-docs/) và chọn ** các mô hình có sẵn (conf/ops) ** để xem danh sách các mô hình.

! [] (./ IMG/learn_models_2.jpg)

## Cách sử dụng pyats parse từ CLI

Tương tự như pyats tìm hiểu, pyats parse có thể được sử dụng từ CLI để biến các lệnh `show` phổ biến thành JSON có cấu trúc.Có hàng ngàn trình phân tích cú pháp có sẵn.

Truy cập [Pyats Parsers] (https://developer.cisco.com/docs/genie-docs/) và chọn `trình phân tích cú pháp có sẵn để xem danh sách các mô hình.

! [] (./ IMG/Parser_1.jpg)

Theo mặc định, tất cả các trình phân tích cú pháp có sẵn sẽ được hiển thị, nhưng bạn có thể lọc bằng hệ điều hành, ví dụ, `iOS XE`.

! [] (./ IMG/Parser_2.jpg)

Ví dụ, bạn có thể sử dụng tìm kiếm để lọc các kết quả, `Hiển thị giao diện IP`.

! [] (./ IMG/Parser_3.jpg)

Sử dụng lệnh sau để phân tích cú pháp `show ip giao diện tóm tắt` từ CLI:

```bash
(pyats-env) $ pyats parse "show ip interface brief" --testbed-file testbed_ssh.yaml
```
Lệnh này sẽ hiển thị phiên bản JSON được phân tích cú pháp của lệnh CLI lên màn hình.Nếu bạn muốn lưu đầu ra, bạn có thể thêm cờ `--Output`, sẽ tạo một thư mục chứa ba tệp (nhật ký kết nối, đầu ra CLI thô và JSON được phân tích cú pháp):

```bash
(pyats-env) $ pyats parse "show ip interface brief" --testbed-file testbed_ssh.yaml --output show_ip_interface_brief
```

Sử dụng mã VS để khám phá các tệp.

Hãy thử một số lệnh `show` khác từ các trình phân tích cú pháp iOS XE có sẵn.

## Cách tạo công việc Pyats

Bây giờ chúng tôi đã chứng minh sức mạnh của các trình phân tích cú pháp và mô hình PYATS bằng cách sử dụng một tệp thử nghiệm đơn giản, chúng tôi có thể tạo các thử nghiệm chống lại các khóa và giá trị JSON.Các công việc của Pyats là các tập lệnh Python 3 sử dụng tệp được kiểm tra có thể được sử dụng để kiểm tra, tài liệu, ảnh chụp nhanh, vi sai và thậm chí quản lý cấu hình.

Các công việc của Pyats được tạo thành từ ba tệp: thử nghiệm, tệp công việc và tập lệnh Python 3.Tệp công việc là một tệp điều khiển tải tệp được kiểm tra và tệp logic Python và sử dụng khung Pyats.Trong ví dụ của chúng tôi, tập lệnh của chúng tôi sẽ được gọi là "Luôn luôn_ON_IOS_XE_SSH.PY".

Tạo tệp Python (.py) sau đây được gọi là luôn luôn có tên

```python
import os
from genie.testbed import load

def main(runtime):

  # Load the testbed
  if not runtime.testbed:
    # If no testbed is provided, load the default testbed
    # Load the default location of the testbed
    testbedfile = os.path.join('testbed_ssh.yaml')
    testbed = load(testbedfile)
  else:
    # Use the one provided
    testbed = runtime.testbed

  # Find the location of the script in relation to the job file
  testscript = os.path.join(os.path.dirname(__file__), 'always_on_ios_xe_ssh.py')

  # Run the script
  runtime.tasks.run(testscript=testscript, testbed=testbed)
```

## Cách tạo tập lệnh Pyats

Các tập lệnh kiểm tra Pyats có một cách tiếp cận phổ quát có thể được sử dụng để giúp người dùng phát triển các tập lệnh kiểm tra của họ:

- ** Cài đặt chung **: Thiết lập kết nối với các vòng thiết lập thiết bị cho các thử nghiệm với nhiều thiết bị
- ** Testcase (s) **: Boolean Pass/thất bại do người dùng xác định
- ** Dọn dẹp thông thường **: Ngắt kết nối duyên dáng với các thiết bị bất kỳ hoạt động dọn dẹp cần thiết nào

Hãy bắt đầu tập lệnh kiểm tra Pyats của chúng tôi với các phần thiết lập chung và các phần dọn dẹp phổ biến trước và sau đó viết một số bài kiểm tra.Chúng tôi sẽ sử dụng Pyats Aetest, khai thác và biểu ngữ thử nghiệm cốt lõi cho đầu ra đẹp, cũng như gói Python Tabulation để tạo ra đầu ra bảng của các thử nghiệm của chúng tôi trong ghi nhật ký Pyats.Tabulation là tùy chọn nhưng được sử dụng ở đây để tạo các bảng dễ đọc của kết quả kiểm tra.

Tạo tệp luôn luôn luôn luôn như sau:

```python
import logging
from pyats import aetest
from pyats.log.utils import banner
from tabulate import tabulate

# Get logger for script
log = logging.getLogger(__name__)

# AE Test Setup
class common_setup(aetest.CommonSetup):
  """Common Setup Section"""

# Connect to devices
    @aetest.subsection
    def connect_to_devices(self, testbed):
        """Connect to all the devices"""
        testbed.connect()

# Mark the loop for interface tests
# If you add more than 1 device to the testbed this will mark the testcases to be looped over each device
    @aetest.subsection
    def loop_mark(self, testbed):
        aetest.loop.mark(Test_IOS_XE_Interfaces, device_name=testbed.devices)

# AE Test Cleanip
class CommonCleanup(aetest.CommonCleanup):
    @aetest.subsection
    def disconnect_from_devices(self, testbed):
        testbed.disconnect()

# for running as its own executable
if __name__ == '__main__':
    aetest.main()
```

## Cách kiểm tra bộ đếm giao diện

Bây giờ chúng tôi có thiết lập chung và dọn dẹp phổ biến được xác định, chúng tôi có thể viết các thử nghiệm cho các bộ đếm giao diện.Như được chỉ định trong vòng lặp thiết lập chung, chúng tôi muốn tạo trường hợp lớp và thử nghiệm được gọi là "test_ios_xe_interfaces" giữa các lớp thiết lập chung và các lớp dọn dẹp phổ biến.

```python
class Test_IOS_XE_Interfaces(aetest.Testcase):
    """Parse the pyATS Learn Interface Data"""

    @aetest.test
    def setup(self, testbed, device_name):
        """ Testcase Setup section """
        # connect to device
        self.device = testbed.devices[device_name]
        # Loop over devices in tested for testing

    @aetest.test
    def get_pre_test_interface_data(self):
        self.parsed_interfaces = self.device.learn("interface")

    @aetest.test
    def test_interface_input_errors(self):
        # Test for input discards
        in_errors_threshold = 0
        self.failed_interfaces = {}
        table_data = []
        for intf,value in self.parsed_interfaces.info.items():
            if 'counters' in value:
                counter = value['counters']['in_errors']
                table_row = []
                table_row.append(self.device.alias)
                table_row.append(intf)
                table_row.append(counter)
                if int(counter) > in_errors_threshold:
                    table_row.append('Failed')
                    self.failed_interfaces[intf] = int(counter)
                    self.interface_name = intf
                    self.error_counter = self.failed_interfaces[intf]
                else:
                    table_row.append('Passed')
                table_data.append(table_row)

        # display the table
        log.info(tabulate(table_data,
            headers=['Device', 'Interface',
                    'Input Errors Counter',
                    'Passed/Failed'],
                    tablefmt='orgtbl'))

        # should we pass or fail?
        if self.failed_interfaces:
            self.failed('Some interfaces have input errors')
        else:
            self.passed('No interfaces have input errors')
```

Bây giờ chúng tôi có một công việc PYATS hoàn chỉnh, với một tệp công việc và tập lệnh kiểm tra kiểm tra các lỗi đầu vào trên các giao diện, chúng tôi có thể chạy công việc:

```bash
(pyats-env) $ pyats run job always_on_ios_xe_ssh_job.py
```

Nếu có bất kỳ cặp giá trị khóa giao diện nào cho các lỗi đầu vào lớn hơn 0, thử nghiệm trên giao diện đó sẽ không thành công và trường hợp thử nghiệm sẽ được đánh dấu là không thành công.Mặt khác, thử nghiệm trên mỗi giao diện sẽ vượt qua và nếu tất cả các giao diện vượt qua, trường hợp thử nghiệm sẽ vượt qua.

Sử dụng Pyats Learn Interface JSON, bạn có thể thêm nhiều trường hợp kiểm tra.Bạn có thể thêm nhiều bài kiểm tra bằng cách sao chép và dán chức năng ** test_interface_input_errors (self) ** và thay đổi giá trị khóa thành, ví dụ, các lỗi CRC.Hãy tiếp tục và thêm một bài kiểm tra khác cho ** Lỗi CRC ** và chạy lại tệp công việc.

## Cách xem nhật ký Pyats

Vào cuối công việc PYATS, nó sẽ thông báo cho bạn rằng tệp nhật ký có sẵn để xem trình xem nhật ký HTML theo yêu cầu.Nhập chế độ xem nhật ký Pyats, sẽ khởi chạy một máy chủ web cục bộ.Bạn có thể nhấp vào liên kết và khởi chạy để xem nhật ký trong trang HTML phong phú.

```bash
pyats logs view
```

Kiểm tra nhật ký của công việc PYATS của bạn trong trình xem nhật ký.

## Tài liệu tham khảo:

- [Tăng tốc DevOps của bạn với Pyats] (https://developer.cisco.com/pyats/)
- [Tài liệu Pyats] (https://developer.cisco.com/docs/pyats/)
- [Tài liệu Genie] (https://developer.cisco.com/docs/genie-docs/)
-
